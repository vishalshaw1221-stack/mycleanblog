---
/*
  Final merged slug file for:
  src/pages/blog/[...slug].astro

  - Preserves original layout + styles
  - Adds full automatic SEO + JSON-LD
  - Uses SITE_URL as canonical base (change if needed)
*/

import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { SEO } from "astro-seo";

const SITE_URL = "https://mycleanblog.vercel.app"; // <-- change to your real site if different

export async function getStaticPaths() {
  const blogPosts = await getCollection("blog");
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

// Render the content (Astro collections .render may return Content + html)
const rendered = await post.render();
const Content = rendered.Content;

// Try to extract plain text safely (use post.body if available, else rendered.html)
const rawSource = (post?.body) || (rendered?.html) || "";
const plainText = String(rawSource)
  .replace(/[\r\n]+/g, " ")
  .replace(/[#>*_`~\-]{1,}/g, "") // strip markdown marks (best-effort)
  .replace(/<[^>]*>/g, "") // strip HTML tags
  .trim();

// ===================
// AUTO SEO LOGIC
// ===================

// Title fallback from frontmatter or slug
const title =
  (post?.data?.title && String(post.data.title).trim()) ||
  post.slug.replace(/-/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());

// Auto description: prefer frontmatter.description, else first 160 chars of plain text
const rawDescription =
  (post?.data?.description && String(post.data.description).trim()) ||
  (plainText ? plainText.slice(0, 160) : "");
const description = rawDescription + (rawDescription.length >= 160 ? "..." : "");

// Keywords: top frequent words (>4 letters)
const textForKeywords = ((title || "") + " " + (plainText || ""))
  .toLowerCase()
  .replace(/[^\w\s]/g, "");
const words = textForKeywords.split(/\s+/).filter(Boolean);
const frequency = {};
words.forEach((w) => {
  if (w.length > 4) frequency[w] = (frequency[w] || 0) + 1;
});
const keywords = Object.keys(frequency)
  .sort((a, b) => frequency[b] - frequency[a])
  .slice(0, 10)
  .join(", ");

// Image fallback
const image = post?.data?.heroImage || post?.data?.image || "/images/default-og.png";

// canonical URL for this post
const canonicalUrl = Astro.url?.href || `${SITE_URL}/blog/${post.slug}`;

// published / modified timestamps
const datePublished = post?.data?.pubDate
  ? new Date(post.data.pubDate).toISOString()
  : null;
const dateModified = post?.data?.updated
  ? new Date(post.data.updated).toISOString()
  : post?.data?.modified
  ? new Date(post.data.modified).toISOString()
  : datePublished;

// JSON-LD Article Schema
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description,
  image,
  author: {
    "@type": "Person",
    name: "Vishal Kumar Shaw",
    url: `${SITE_URL}/about`,
  },
  publisher: {
    "@type": "Organization",
    name: "Vishal Kumar Shaw",
    logo: {
      "@type": "ImageObject",
      url: `${SITE_URL}/images/logo.png`,
    },
  },
  url: canonicalUrl,
  datePublished,
  dateModified,
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": canonicalUrl,
  },
};

// Breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    {
      "@type": "ListItem",
      position: 1,
      name: "Home",
      item: SITE_URL + "/",
    },
    {
      "@type": "ListItem",
      position: 2,
      name: post?.data?.category || "Blog",
      item:
        SITE_URL +
        "/categories/" +
        ((post?.data?.category || "blog").toString().toLowerCase() || "blog"),
    },
    {
      "@type": "ListItem",
      position: 3,
      name: title,
      item: canonicalUrl,
    },
  ],
};

// Organization + WebSite global schema (helpful to also include at page level)
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  name: "Vishal Kumar Shaw",
  url: SITE_URL,
  logo: `${SITE_URL}/images/logo.png`,
  sameAs: [
    /* replace with your real profiles if you want */
    "https://x.com/yourprofile",
    "https://www.linkedin.com/in/yourprofile",
  ],
  founder: {
    "@type": "Person",
    name: "Vishal Kumar Shaw",
    jobTitle: "Science Writer & Digital Creator",
    url: `${SITE_URL}/about`,
  },
};

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: "Vishal Kumar Shaw Blog",
  url: SITE_URL,
  potentialAction: {
    "@type": "SearchAction",
    target: `${SITE_URL}/search?q={search_term_string}`,
    "query-input": "required name=search_term_string",
  },
};

// Combined SEO props for astro-seo
const seoProps = {
  title,
  description,
  canonical: canonicalUrl,
  keywords,
  openGraph: {
    basic: {
      title,
      type: "article",
      image,
      url: canonicalUrl,
    },
    article: {
      publishedTime: datePublished,
      modifiedTime: dateModified,
      authors: [`${SITE_URL}/about`],
    },
  },
  twitter: {
    card: "summary_large_image",
    site: "@yourtwitterhandle", // replace if you have a Twitter/X handle
  },
};
---

<Layout
  title={title}
  description={description}
  image={image}
  seo={seoProps}
>
  <!-- inject SEO meta via astro-seo -->
  <SEO {...seoProps} />

  <!-- ============================
       ARTICLE MARKUP (preserved & optimized)
       ============================ -->
  <article class="blog-post">
    <header class="post-header">
      <h1 class="post-title">{title}</h1>

      <div class="post-meta">
        <span class="publish-date">
          üìÖ Published:{" "}
          {post?.data?.pubDate
            ? new Date(post.data.pubDate).toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            : "Unknown"}
        </span>

        {post?.data?.readTime && (
          <span class="read-time">‚è±Ô∏è {post.data.readTime}</span>
        )}

        {post?.data?.tags && Array.isArray(post.data.tags) && (
          <span class="tags"> ‚Ä¢ {post.data.tags.join(", ")}</span>
        )}
      </div>

      {image && (
        <div class="hero-image">
          <img src={image} alt={post?.data?.title || "Article image"} />
        </div>
      )}
    </header>

    <div class="content-wrapper">
      <Content />
    </div>

    <footer class="post-footer">
      <a href="/" class="back-home">‚Üê Back to Home</a>
    </footer>
  </article>

  <!-- ============================
       STRUCTURED DATA FOR GOOGLE
       (Article, Breadcrumb, Organization, WebSite)
       ============================ -->
  <script type="application/ld+json">{JSON.stringify(articleSchema)}</script>
  <script type="application/ld+json">{JSON.stringify(breadcrumbSchema)}</script>
  <script type="application/ld+json">{JSON.stringify(organizationSchema)}</script>
  <script type="application/ld+json">{JSON.stringify(websiteSchema)}</script>
</Layout>

<!-- ============================
     STYLES ‚Äî preserved + responsive
     ============================ -->
<style>
  :root {
    --space-blue: #0f172a;
    --quantum-purple: #4c1d95;
    --atom-red: #dc2626;
    --lab-white: #f8fafc;
    --neutron-gray: #64748b;
    --electron-blue: #3b82f6;
  }

  .blog-post {
    max-width: 900px;
    margin: 0 auto;
    padding: 2.2rem;
    color: var(--lab-white);
    box-sizing: border-box;
  }

  .post-header {
    margin-bottom: 2.5rem;
    text-align: center;
    border-bottom: 2px solid rgba(59,130,246,0.12);
    padding-bottom: 1.8rem;
  }

  .post-title {
    font-size: 2.6rem;
    font-weight: 800;
    margin-bottom: 0.8rem;
    background: linear-gradient(135deg, var(--electron-blue), var(--atom-red));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.12;
  }

  .post-meta {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
    color: var(--neutron-gray);
    font-size: 0.95rem;
    align-items: center;
  }

  .hero-image {
    margin-top: 1.2rem;
  }

  .hero-image img {
    width: 100%;
    height: auto;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.35);
  }

  .content-wrapper {
    line-height: 1.75;
    font-size: 1.08rem;
    margin-top: 1.8rem;
    color: var(--lab-white);
  }

  .content-wrapper h2 {
    font-size: 1.7rem;
    margin: 2rem 0 1rem;
    color: var(--electron-blue);
  }

  .content-wrapper h3 {
    font-size: 1.35rem;
    margin: 1.5rem 0 0.8rem;
    color: var(--atom-red);
  }

  .content-wrapper p {
    margin-bottom: 1rem;
    text-align: justify;
  }

  .content-wrapper pre {
    background: rgba(15,23,42,0.92);
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 1rem 0;
    border: 1px solid rgba(59,130,246,0.08);
  }

  .content-wrapper code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    font-size: 0.95rem;
  }

  .content-wrapper img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1rem 0;
  }

  .post-footer {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(59,130,246,0.06);
    text-align: center;
  }

  .back-home {
    display: inline-flex;
    gap: 0.5rem;
    align-items: center;
    color: var(--electron-blue);
    text-decoration: none;
    font-weight: 700;
    padding: 0.6rem 1rem;
    border-radius: 8px;
    border: 1px solid rgba(59,130,246,0.15);
    transition: all 0.18s ease;
    background: rgba(59,130,246,0.04);
  }

  .back-home:hover {
    transform: translateY(-3px);
    background: rgba(59,130,246,0.12);
  }

  /* Responsive */
  @media (max-width: 900px) {
    .post-title { font-size: 2.1rem; }
    .blog-post { padding: 1.4rem; }
    .content-wrapper { font-size: 1rem; }
  }

  @media (max-width: 480px) {
    .post-title { font-size: 1.6rem; }
    .post-meta { font-size: 0.9rem; gap: 0.6rem; }
  }
</style>