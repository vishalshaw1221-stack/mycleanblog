---
import Analytics from '@vercel/analytics/astro'
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { SEO } from "astro-seo";

/*
  Layout.astro - merged & SEO-enhanced version for "Physics in physics"
  - Author: Vishal Kumar Shaw
  - Default site: https://mycleanblog.vercel.app/
  - Keeps your original styling and scripts
  - Adds OpenGraph, Twitter, canonical, robots, JSON-LD structured data
*/

// Props the pages can pass in (slug.astro will pass these)
const {
  title = "Physics in physics",
  description = "Physics in physics â€” ideas, explanations, and notes on physics & maths.",
  image = "/og-image.png",
  // Accept seo as an object from pages (contains canonical, keywords, openGraph, twitter)
  seo = {},
  url = "https://mycleanblog.vercel.app/", // fallback canonical/base URL
} = Astro.props;

// Social profiles (you provided these)
const socialProfiles = [
  "https://www.facebook.com/profile.php?id=61583067824148",
  "https://www.instagram.com/physicsinphysics/",
  "https://x.com/PhysicsP32590",
  "https://www.linkedin.com/me?trk=p_mwlite_feed-secondary_nav",
  "https://m.youtube.com/channel/UCQeEKqqidI7I0etj-Io0CZA/videos"
];

// Build JSON-LD structuredData (Person + Organization + Website)
// If this page is an article, pages can add more article-specific structured data.
const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Person",
      "@id": `${url}#person`,
      "name": "Vishal Kumar Shaw",
      "url": url,
      "sameAs": socialProfiles,
    },
    {
      "@type": "Organization",
      "@id": `${url}#organization`,
      "name": "Physics in physics",
      "url": url,
      "logo": {
        "@type": "ImageObject",
        "url": (seo?.openGraph?.images?.[0]?.url) || image || `${url}favicon.ico`
      },
      "sameAs": socialProfiles
    },
    {
      "@type": "WebSite",
      "@id": `${url}#website`,
      "url": url,
      "name": title,
      "description": description,
      "publisher": {
        "@id": `${url}#organization`
      }
    }
  ]
};

// If page sends article-level structured data via seo.articleSchema, merge it:
if (seo?.articleSchema) {
  // Insert article schema with mainEntityOfPage referencing this page
  structuredData["@graph"].push({
    "@type": "Article",
    ...seo.articleSchema,
    mainEntityOfPage: seo?.canonical || Astro.url.href || url
  });
}

// Compose final meta values with fallbacks
const metaTitle = seo?.openGraph?.title || seo?.title || title;
const metaDescription = seo?.openGraph?.description || seo?.description || description;
const metaImage = seo?.openGraph?.images?.[0]?.url || seo?.image || image;
const canonicalUrl = seo?.canonical || Astro.url.href || url;
const metaKeywords = seo?.keywords || "";
const twitterHandle = seo?.twitter?.creator || seo?.twitter?.site || "@yourtwitterhandle";
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J0V6QXQ31L"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-J0V6QXQ31L');
</script>

<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4S50023WZL');
</script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Primary title + description -->
    <title>{metaTitle}{metaTitle && metaTitle.includes("Physics in physics") ? "" : ` | Physics in physics`}</title>
    <meta name="description" content={metaDescription} />
    <meta name="keywords" content={metaKeywords} />
    <meta name="author" content="Vishal Kumar Shaw" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href={canonicalUrl} />

    <!-- SEO Helper (astro-seo) - safe to keep, still add manual tags too -->
    <SEO
      title={metaTitle}
      description={metaDescription}
      canonical={canonicalUrl}
      openGraph={{
        basic: {
          title: metaTitle,
          type: seo?.openGraph?.type || "website",
          image: metaImage,
          url: canonicalUrl,
          description: metaDescription,
        },
        // if the page provided images array, include it
        images: seo?.openGraph?.images || [{ url: metaImage }],
      }}
      twitter={{
        card: seo?.twitter?.card || "summary_large_image",
        site: twitterHandle,
        creator: twitterHandle,
      }}
    />
    <!-- âœ… JSON-LD Structured Data -->
<script type="application/ld+json">
{JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Organization",
  name: "Physics in Physics",
  url: "https://mycleanblog.vercel.app/",
  logo: "https://mycleanblog.vercel.app/favicon.svg",
  sameAs: [
    "https://www.facebook.com/profile.php?id=61583067824148",
    "https://www.instagram.com/physicsinphysics/",
    "https://x.com/PhysicsP32590",
    "https://www.linkedin.com/me?trk=p_mwlite_feed-secondary_nav",
    "https://m.youtube.com/channel/UCQeEKqqidI7I0etj-Io0CZA/videos",
  ],
  description: description,
  founder: {
    "@type": "Person",
    name: "Vishal Kumar Shaw",
  },
  publisher: {
    "@type": "Organization",
    name: "Physics in Physics",
    logo: {
      "@type": "ImageObject",
      url: "https://mycleanblog.vercel.app/favicon.svg",
    },
  },
})}
</script>

    <!-- Open Graph -->
    <meta property="og:site_name" content="Physics in physics" />
    <meta property="og:type" content={seo?.openGraph?.type || "website"} />
    <meta property="og:title" content={metaTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:image" content={metaImage} />
    <meta property="og:url" content={canonicalUrl} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content={seo?.twitter?.card || "summary_large_image"} />
    <meta name="twitter:title" content={metaTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={metaImage} />
    <meta name="twitter:site" content={twitterHandle} />
    <meta name="twitter:creator" content={twitterHandle} />

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

    <!-- Structured data JSON-LD -->
    <script type="application/ld+json">
      {JSON.stringify(structuredData)}
    </script>

    <!-- Performance / fonts -->
    <meta name="theme-color" content="#0f172a" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome (kept from your original) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Your original styles (kept intact) -->
    <style>
      :root {
        --space-blue: #0f172a;
        --quantum-purple: #4c1d95;
        --atom-red: #dc2626;
        --lab-white: #f8fafc;
        --neutron-gray: #64748b;
        --electron-blue: #3b82f6;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(
          135deg,
          var(--space-blue) 0%,
          var(--quantum-purple) 100%
        );
        color: white;
        font-family: "Arial", sans-serif;
        padding: 0;
        width: 100%;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background:
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M0,50 Q25,30 50,50 T100,50' stroke='rgba(59,130,246,0.12)' stroke-width='1.5' fill='none'/%3E%3Cpath d='M0,30 Q25,70 50,30 T100,30' stroke='rgba(220,38,38,0.12)' stroke-width='1.5' fill='none'/%3E%3C/svg%3E")
            center/250px 250px,
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cline x1='20' y1='20' x2='80' y2='80' stroke='rgba(59,130,246,0.08)' stroke-width='1.5'/%3E%3Cline x1='80' y1='20' x2='20' y2='80' stroke='rgba(220,38,38,0.08)' stroke-width='1.5'/%3E%3C/svg%3E")
            center/200px 200px,
          linear-gradient(135deg, #0f172a 0%, #4c1d95 100%);
        opacity: 1;
        z-index: -1;
        pointer-events: none;
      }

      main::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.3);
        backdrop-filter: blur(2px);
        border-radius: 15px;
        z-index: -1;
        pointer-events: none;
      }

      main {
        position: relative;
        z-index: 1;
      }

      header,
      footer {
        width: 80%;
        max-width: 1100px;
        border-radius: 15px;
        box-sizing: border-box;
      }

      main {
        width: 85%;
        max-width: 1200px;
        border-radius: 15px;
        box-sizing: border-box;
        margin: 0 auto 2rem auto;
      }

      header {
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid var(--electron-blue);
        box-shadow: 0 0 25px rgba(59, 130, 246, 0.25);
        padding: 1rem;
        margin: 1.5rem auto;
      }

      main {
        flex-grow: 1;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(59, 130, 246, 0.3);
        box-shadow: 0 0 40px rgba(59, 130, 246, 0.25);
        padding: 3rem 2rem;
      }

      footer {
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid var(--electron-blue);
        box-shadow: 0 0 25px rgba(59, 130, 246, 0.25);
        padding: 3rem 2rem 2rem;
        text-align: center;
        position: relative;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin: 0 auto 2rem auto;
      }

      footer::before {
        content: "";
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 2px;
        background: linear-gradient(
          90deg,
          var(--electron-blue),
          var(--atom-red),
          var(--quantum-purple)
        );
        box-shadow: 0 0 15px var(--electron-blue);
        border-radius: 5px;
      }

      /* ðŸ”¥ MOBILE FIXES */
      @media (max-width: 768px) {
        html {
          font-size: 14px;
        }

        body {
          padding: 0 10px;
          width: 100%;
          box-sizing: border-box;
        }

        header,
        main,
        footer {
          width: 100% !important;
          max-width: 100% !important;
          margin-left: auto !important;
          margin-right: auto !important;
          border-radius: 10px;
        }

        header {
          padding: 0.8rem;
          margin: 0.8rem auto;
        }

        main {
          padding: 1.5rem 1rem !important;
          margin: 0 auto 1rem auto !important;
        }

        footer {
          padding: 1.5rem 1rem !important;
          margin: 0 auto 1rem auto !important;
          min-height: 150px;
        }

        h1 {
          font-size: 1.5rem !important;
        }
        h2 {
          font-size: 1.3rem !important;
        }
        h3 {
          font-size: 1.1rem !important;
        }
        p,
        li {
          font-size: 0.95rem !important;
        }

        .search-suggestions {
          position: fixed !important;
          left: 10px !important;
          right: 10px !important;
          width: calc(100% - 20px) !important;
        }
      }

      @media (max-width: 480px) {
        html {
          font-size: 13px;
        }

        header,
        main,
        footer {
          border-radius: 8px;
        }

        main {
          padding: 1rem 0.8rem !important;
        }

        h1 {
          font-size: 1.3rem !important;
        }
        h2 {
          font-size: 1.1rem !important;
        }
      }

      /* Search Styles */
      .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(15, 23, 42, 0.98);
        border: 1px solid var(--electron-blue);
        border-radius: 8px;
        margin-top: 5px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
      }

      .suggestion-item {
        padding: 12px 15px;
        color: white;
        cursor: pointer;
        border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        transition: background 0.2s;
      }

      .suggestion-item:hover {
        background: rgba(59, 130, 246, 0.3);
      }

      .suggestion-title {
        font-weight: bold;
        font-size: 1rem;
        margin-bottom: 4px;
      }

      .suggestion-desc {
        font-size: 0.8rem;
        color: #cbd5e1;
        opacity: 0.8;
      }

      .no-results {
        padding: 12px 15px;
        color: var(--neutron-gray);
        text-align: center;
      }

      .search-container {
        position: relative;
      }
    </style>
  </head>

  <body>
    <header>
      <Header />
    </header>

    <main>
      <slot />
    </main>

    <footer>
      <Footer />
    </footer>

    <!-- Search Script (keeps your original logic) -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.querySelector(".search-input");
        const searchButton = document.querySelector(".search-button");

        let blogData = [];

        async function loadBlogData() {
          try {
            const posts = await getCollection("blog");
            blogData = posts.map((post) => ({
              id: post.slug,
              title: post.data.title,
              description: post.data.description,
              content: post.body,
              tags: post.data.tags || [],
            }));
          } catch (error) {
            blogData = [
              {
                id: "quantum-physics",
                title: "Understanding Quantum Physics",
                description: "Quantum physics is a very interesting subject...",
                content: "Your blog content here...",
                tags: ["physics", "science"],
              },
              {
                id: "ai-future",
                title: "The Future of Artificial Intelligence",
                description:
                  "Exploring AI advancements and machine learning",
                content:
                  "Artificial intelligence is transforming how we live and work...",
                tags: ["ai", "technology", "machine-learning"],
              },
            ];
          }
        }

        let suggestionsDiv = null;

        function searchBlogs(searchTerm) {
          const term = searchTerm.toLowerCase().trim();
          if (!term) return [];
          return blogData.filter(
            (blog) =>
              blog.title.toLowerCase().includes(term) ||
              blog.description.toLowerCase().includes(term) ||
              blog.content.toLowerCase().includes(term) ||
              blog.tags.some((tag) => tag.toLowerCase().includes(term))
          );
        }

        function showSuggestions() {
          const searchTerm = searchInput.value;
          if (suggestionsDiv) suggestionsDiv.remove();
          if (!searchTerm) return;

          const results = searchBlogs(searchTerm);
          suggestionsDiv = document.createElement("div");
          suggestionsDiv.className = "search-suggestions";

          if (results.length > 0) {
            suggestionsDiv.innerHTML = results
              .map(
                (blog) => `
              <div class="suggestion-item" data-blog-id="${blog.id}">
                <div class="suggestion-title">${blog.title}</div>
                <div class="suggestion-desc">${blog.description}</div>
              </div>`
              )
              .join("");
          } else {
            suggestionsDiv.innerHTML =
              '<div class="no-results">No blogs found matching your search</div>';
          }

          const searchContainer = searchInput.closest(".search-container");
          searchContainer.appendChild(suggestionsDiv);

          suggestionsDiv
            .querySelectorAll(".suggestion-item")
            .forEach((item) => {
              item.addEventListener("click", () => {
                const blogId = item.dataset.blogId;
                window.location.href = `/blog/${blogId}`;
              });
            });
        }

        function performSearch() {
          const searchTerm = searchInput.value.trim();
          if (!searchTerm) return;
          const results = searchBlogs(searchTerm);
          if (results.length > 0) {
            window.location.href = `/blog/${results[0].id}`;
          } else {
            alert(`No blogs found for "${searchTerm}"`);
          }
          hideSuggestions();
        }

        function hideSuggestions() {
          if (suggestionsDiv) {
            suggestionsDiv.remove();
            suggestionsDiv = null;
          }
        }

        loadBlogData();

        if (searchInput) {
          searchInput.addEventListener("input", showSuggestions);
          searchInput.addEventListener("focus", showSuggestions);
          searchButton.addEventListener("click", performSearch);
          searchInput.addEventListener(
            "keypress",
            (e) => e.key === "Enter" && performSearch()
          );

          document.addEventListener("click", (e) => {
            if (!e.target.closest(".search-container")) hideSuggestions();
          });
        }
      });
    </script>
  </body>
</html>